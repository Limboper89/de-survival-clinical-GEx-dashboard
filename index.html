<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gene Expression & Survival Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --color-background: #fcfcf9;
            --color-surface: #fffffe;
            --color-text: #13343b;
            --color-text-secondary: #626c71;
            --color-primary: #21808d;
            --color-primary-hover: #1d7480;
            --color-border: rgba(94, 82, 64, 0.2);
            --color-card-border: rgba(94, 82, 64, 0.12);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: #1f2121;
                --color-surface: #262828;
                --color-text: #f5f5f5;
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-primary: #32b8c6;
                --color-primary-hover: #2da6b2;
                --color-border: rgba(119, 124, 124, 0.3);
                --color-card-border: rgba(119, 124, 124, 0.2);
            }
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
        }

        .header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-card-border);
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .header h1 {
            margin: 0 0 8px 0;
            font-size: 28px;
            font-weight: 600;
            color: var(--color-text);
        }

        .header p {
            margin: 0;
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .controls {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .control-group label {
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text);
        }

        .file-input {
            display: none;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--color-border);
            color: var(--color-text);
        }

        .btn-secondary:hover {
            background: rgba(0, 0, 0, 0.03);
        }

        select {
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 14px;
            cursor: pointer;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: var(--color-primary);
            margin: 0;
        }

        .stat-label {
            font-size: 13px;
            color: var(--color-text-secondary);
            margin: 4px 0 0 0;
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .card h2 {
            margin: 0 0 16px 0;
            font-size: 20px;
            font-weight: 600;
            color: var(--color-text);
        }

        .plot-container {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
        }

        .table-container {
            overflow-x: auto;
            max-height: 500px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: var(--color-surface);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid var(--color-border);
            color: var(--color-text);
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--color-border);
        }

        tr:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        .search-box {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
            background: var(--color-surface);
            color: var(--color-text);
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--color-text-secondary);
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--color-border);
        }

        .tab {
            padding: 10px 16px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--color-text);
        }

        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .plot-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .plot-half {
            width: 100%;
            height: 400px;
        }

        .risk-table {
            margin-top: 20px;
            overflow-x: auto;
        }

        .risk-table table {
            font-size: 12px;
        }

        .gene-selector {
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .gene-selector input {
            flex: 1;
            min-width: 200px;
        }

        .gene-selector button {
            white-space: nowrap;
        }

        .gene-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .gene-chip {
            background: var(--color-secondary);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .gene-chip button {
            background: none;
            border: none;
            color: var(--color-text);
            cursor: pointer;
            padding: 0;
            font-size: 14px;
            line-height: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Gene Expression & Survival Analysis Dashboard</h1>
        <p>Interactive visualization of differential expression and patient survival data</p>
    </div>

    <div class="container">
        <div class="controls">
           
            <div class="control-group">
                <label>Survival Group By:</label>
                <select id="group-select">
                    <option value="Age_Group">Age Group</option>
                    <option value="Gender">Gender</option>
                    <option value="Survival_Group">Survival Group</option>
                </select>
            </div>
            <div class="control-group">
                <label>Volcano Plot Y-axis:</label>
                <select id="volcano-yaxis">
                    <option value="fdr">FDR</option>
                    <option value="p">P-value</option>
                </select>
            </div>
            <div class="control-group">
                <label>Gene for Expression:</label>
                <input type="text" id="gene-input" placeholder="Enter gene ID..." style="padding: 8px 12px; border: 1px solid var(--color-border); border-radius: 8px; background: var(--color-surface); color: var(--color-text); font-size: 14px;">
            </div>
        </div>

        <div class="stats-grid" id="stats-grid"></div>

        <div class="card">
            <h2>Volcano Plots - Differential Expression</h2>
            <div class="tabs">
                <button class="tab active" data-tab="volcano-age">Age Group Comparison</button>
                <button class="tab" data-tab="volcano-sex">Sex Comparison</button>
            </div>
            <div class="tab-content active" id="volcano-age">
                <div class="plot-container" id="plot-volcano-age"></div>
            </div>
            <div class="tab-content" id="volcano-sex">
                <div class="plot-container" id="plot-volcano-sex"></div>
            </div>
        </div>

        <div class="card">
            <h2>Kaplan-Meier Survival Curves</h2>
            <div class="plot-container" id="plot-km"></div>
            <div class="risk-table" id="risk-table"></div>
        </div>

        <div class="card">
            <h2>Gene Expression & Correlation Analysis</h2>
            <div class="gene-selector">
                <input type="text" id="single-gene-input" class="search-box" placeholder="Enter gene ID for violin plot...">
                <button class="btn btn-primary" onclick="updateViolinPlots()">Plot Expression</button>
                <input type="text" id="multi-gene-input" class="search-box" placeholder="Enter gene IDs (comma-separated) for heatmap...">
                <button class="btn btn-primary" onclick="updateHeatmap()">Plot Heatmap</button>
            </div>
            <div class="plot-grid">
                <div>
                    <h3 style="font-size: 16px; margin: 0 0 12px 0;">Expression by Age (≥65 vs &lt;65)</h3>
                    <div class="plot-half" id="plot-violin-age"></div>
                </div>
                <div>
                    <h3 style="font-size: 16px; margin: 0 0 12px 0;">Expression by Gender</h3>
                    <div class="plot-half" id="plot-violin-sex"></div>
                </div>
            </div>
            <div style="margin-top: 24px;">
                <h3 style="font-size: 16px; margin: 0 0 12px 0;">Gene Correlation Heatmap</h3>
                <div class="plot-container" id="plot-heatmap"></div>
            </div>
        </div>

        <div class="card">
            <h2>Gene Search & Data Tables</h2>
            <input type="text" id="gene-search" class="search-box" placeholder="Search for a gene (e.g., ENSG00000000003)...">
            <div class="tabs">
                <button class="tab active" data-tab="table-age">Age Group DE</button>
                <button class="tab" data-tab="table-sex">Sex DE</button>
                <button class="tab" data-tab="table-survival">Patient Data</button>
            </div>
            <div class="tab-content active" id="table-age">
                <div class="table-container" id="table-container-age"></div>
            </div>
            <div class="tab-content" id="table-sex">
                <div class="table-container" id="table-container-sex"></div>
            </div>
            <div class="tab-content" id="table-survival">
                <div class="table-container" id="table-container-survival"></div>
            </div>
        </div>
    </div>

    <script>
        // Global data storage
        let data = {
            agegroup: null,
            sex: null,
            survival: null
        };

        // Auto-load files on page load
        window.onload = function() {
            loadTSVFromURL('de_agegroup_mapped.tsv', 'agegroup');
            loadTSVFromURL('de_male_female_final.tsv', 'sex');
            loadTSVFromURL('dashboard_data.tsv', 'survival');
        };

        // File input handlers (kept for manual override if needed)
        document.getElementById('file-agegroup').addEventListener('change', (e) => loadFile(e, 'agegroup'));
        document.getElementById('file-sex').addEventListener('change', (e) => loadFile(e, 'sex'));
        document.getElementById('file-survival').addEventListener('change', (e) => loadFile(e, 'survival'));
        document.getElementById('group-select').addEventListener('change', updateKMPlot);
        document.getElementById('gene-search').addEventListener('input', filterTables);
        document.getElementById('volcano-yaxis').addEventListener('change', () => {
            if (data.agegroup) createVolcanoPlot(data.agegroup, 'plot-volcano-age', 'Age Group DE');
            if (data.sex) createVolcanoPlot(data.sex, 'plot-volcano-sex', 'Sex DE');
        });
        document.getElementById('gene-input').addEventListener('input', (e) => {
            const gene = e.target.value.trim();
            if (gene) {
                document.getElementById('single-gene-input').value = gene;
            }
        });

        // Tab switching
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.dataset.tab;
                const parent = tab.closest('.card');
                parent.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                parent.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                parent.querySelector(`#${tabId}`).classList.add('active');
            });
        });

        function loadTSVFromURL(url, type) {
            fetch(url)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Failed to load ${url}`);
                    }
                    return response.text();
                })
                .then(text => {
                    const results = Papa.parse(text, {
                        header: true,
                        delimiter: '\t',
                        dynamicTyping: true,
                        skipEmptyLines: true
                    });
                    data[type] = results.data;
                    updateDashboard();
                    console.log(`Successfully loaded ${url}`);
                })
                .catch(error => {
                    console.warn(`Could not auto-load ${url}:`, error);
                });
        }

        function loadFile(event, type) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                delimiter: '\t',
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: (results) => {
                    data[type] = results.data;
                    updateDashboard();
                },
                error: (error) => {
                    console.error('Error parsing file:', error);
                    alert('Error loading file. Please check the format.');
                }
            });
        }

        function updateDashboard() {
            updateStats();
            if (data.agegroup) {
                createVolcanoPlot(data.agegroup, 'plot-volcano-age', 'Age Group DE');
                createDataTable(data.agegroup, 'table-container-age');
            }
            if (data.sex) {
                createVolcanoPlot(data.sex, 'plot-volcano-sex', 'Sex DE');
                createDataTable(data.sex, 'table-container-sex');
            }
            if (data.survival) {
                updateKMPlot();
                createDataTable(data.survival, 'table-container-survival');
            }
        }

        function updateStats() {
            const statsGrid = document.getElementById('stats-grid');
            const stats = [];

            if (data.agegroup) {
                const sig = data.agegroup.filter(d => d.fdr < 0.05).length;
                stats.push({ value: data.agegroup.length, label: 'Genes (Age)' });
                stats.push({ value: sig, label: 'Significant (Age, FDR<0.05)' });
            }

            if (data.sex) {
                const sig = data.sex.filter(d => d.fdr < 0.05).length;
                stats.push({ value: data.sex.length, label: 'Genes (Sex)' });
                stats.push({ value: sig, label: 'Significant (Sex, FDR<0.05)' });
            }

            if (data.survival) {
                stats.push({ value: data.survival.length, label: 'Patients' });
                const events = data.survival.filter(d => d.Event === 1).length;
                stats.push({ value: events, label: 'Events' });
            }

            statsGrid.innerHTML = stats.map(s => `
                <div class="stat-card">
                    <p class="stat-value">${s.value.toLocaleString()}</p>
                    <p class="stat-label">${s.label}</p>
                </div>
            `).join('');
        }

        function createVolcanoPlot(deData, containerId, title) {
            const yAxisType = document.getElementById('volcano-yaxis').value;
            const x = deData.map(d => d.mean_diff || 0);
            const y = deData.map(d => {
                const val = yAxisType === 'fdr' ? d.fdr : d.p;
                return val > 0 ? -Math.log10(val) : 0;
            });
            const genes = deData.map(d => d.gene);
            const colors = y.map(val => val > -Math.log10(0.05) ? 'red' : 'gray');

            const trace = {
                x: x,
                y: y,
                mode: 'markers',
                type: 'scatter',
                text: genes,
                marker: {
                    size: 5,
                    color: colors,
                    opacity: 0.6
                },
                hovertemplate: '<b>%{text}</b><br>Log2FC: %{x:.3f}<br>-log10: %{y:.2f}<extra></extra>'
            };

            const yAxisLabel = yAxisType === 'fdr' ? '-log10(FDR)' : '-log10(P-value)';

            const layout = {
                title: title,
                xaxis: { title: 'Log2 Fold Change (mean_diff)', zeroline: true },
                yaxis: { title: yAxisLabel },
                hovermode: 'closest',
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { family: '-apple-system, BlinkMacSystemFont, Segoe UI, sans-serif' }
            };

            Plotly.newPlot(containerId, [trace], layout, { responsive: true });
        }

        function updateKMPlot() {
            if (!data.survival) return;

            const groupBy = document.getElementById('group-select').value;
            const groups = {};

            data.survival.forEach(row => {
                const group = row[groupBy];
                if (!group) return;
                if (!groups[group]) groups[group] = [];
                groups[group].push({ time: row.Survival_Time, event: row.Event });
            });

            const traces = [];
            Object.keys(groups).forEach(group => {
                const kmData = calculateKM(groups[group]);
                traces.push({
                    x: kmData.times,
                    y: kmData.survival,
                    mode: 'lines',
                    name: group,
                    line: { shape: 'hv', width: 2 },
                    hovertemplate: '<b>' + group + '</b><br>Time: %{x}<br>Survival: %{y:.3f}<extra></extra>'
                });
            });

            const layout = {
                title: 'Kaplan-Meier Survival Curves by ' + groupBy,
                xaxis: { title: 'Survival Time (days)' },
                yaxis: { title: 'Survival Probability', range: [0, 1.05] },
                hovermode: 'closest',
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { family: '-apple-system, BlinkMacSystemFont, Segoe UI, sans-serif' }
            };

            Plotly.newPlot('plot-km', traces, layout, { responsive: true });
            
            // Create risk table
            createRiskTable(groups, groupBy);
        }

        function createRiskTable(groups, groupBy) {
            const riskTableDiv = document.getElementById('risk-table');
            
            // Calculate time intervals (every 100 days)
            let maxTime = 0;
            Object.values(groups).forEach(g => {
                g.forEach(d => {
                    if (d.time > maxTime) maxTime = d.time;
                });
            });
            
            const intervals = [];
            for (let t = 0; t <= maxTime; t += 100) {
                intervals.push(t);
            }
            
            // Calculate at-risk counts
            const riskData = {};
            Object.keys(groups).forEach(group => {
                riskData[group] = intervals.map(time => {
                    return groups[group].filter(d => d.time >= time).length;
                });
            });
            
            // Create table
            let tableHTML = '<table><thead><tr><th>Time</th>';
            Object.keys(riskData).forEach(group => {
                tableHTML += `<th>${group}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            intervals.forEach((time, i) => {
                tableHTML += `<tr><td>${time}</td>`;
                Object.keys(riskData).forEach(group => {
                    tableHTML += `<td>${riskData[group][i]}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            riskTableDiv.innerHTML = tableHTML;
        }

        function calculateKM(data) {
            // Sort by time
            data.sort((a, b) => a.time - b.time);

            const times = [0];
            const survival = [1.0];
            let atRisk = data.length;
            let survProb = 1.0;

            data.forEach((d, i) => {
                if (d.event === 1) {
                    survProb *= (atRisk - 1) / atRisk;
                    times.push(d.time);
                    survival.push(survProb);
                }
                atRisk--;
            });

            return { times, survival };
        }

        function updateViolinPlots() {
            const geneId = document.getElementById('single-gene-input').value.trim();
            if (!geneId || !data.survival) {
                alert('Please enter a gene ID and load survival data first.');
                return;
            }

            // Find expression values for this gene across patients
            // Assuming the gene expression is in a column matching the gene ID
            const expressionData = data.survival.map(row => ({
                age: row.Age,
                ageGroup: row.Age >= 65 ? '≥65' : '<65',
                gender: row.Gender,
                expression: row[geneId] || row.Mean_Expression || 0
            }));

            // Age group violin plot
            const ageGroups = { '≥65': [], '<65': [] };
            expressionData.forEach(d => {
                if (ageGroups[d.ageGroup]) {
                    ageGroups[d.ageGroup].push(d.expression);
                }
            });

            const ageTraces = Object.keys(ageGroups).map(group => ({
                y: ageGroups[group],
                type: 'violin',
                name: group,
                box: { visible: true },
                meanline: { visible: true }
            }));

            const ageLayout = {
                yaxis: { title: 'Expression Level' },
                showlegend: true,
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { family: '-apple-system, BlinkMacSystemFont, Segoe UI, sans-serif' },
                margin: { t: 20, b: 40, l: 50, r: 20 }
            };

            Plotly.newPlot('plot-violin-age', ageTraces, ageLayout, { responsive: true });

            // Gender violin plot
            const genders = {};
            expressionData.forEach(d => {
                if (!genders[d.gender]) genders[d.gender] = [];
                genders[d.gender].push(d.expression);
            });

            const genderTraces = Object.keys(genders).map(group => ({
                y: genders[group],
                type: 'violin',
                name: group,
                box: { visible: true },
                meanline: { visible: true }
            }));

            const genderLayout = {
                yaxis: { title: 'Expression Level' },
                showlegend: true,
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { family: '-apple-system, BlinkMacSystemFont, Segoe UI, sans-serif' },
                margin: { t: 20, b: 40, l: 50, r: 20 }
            };

            Plotly.newPlot('plot-violin-sex', genderTraces, genderLayout, { responsive: true });
        }

        function updateHeatmap() {
            const geneInput = document.getElementById('multi-gene-input').value.trim();
            if (!geneInput || !data.survival) {
                alert('Please enter gene IDs (comma-separated) and load survival data first.');
                return;
            }

            const geneIds = geneInput.split(',').map(g => g.trim()).filter(g => g);
            if (geneIds.length < 2) {
                alert('Please enter at least 2 genes for correlation analysis.');
                return;
            }

            // Extract expression data for selected genes
            const geneExpressions = {};
            geneIds.forEach(gene => {
                geneExpressions[gene] = data.survival.map(row => row[gene] || row.Mean_Expression || 0);
            });

            // Calculate correlation matrix
            const correlationMatrix = [];
            const labels = [];
            
            geneIds.forEach(gene1 => {
                const row = [];
                geneIds.forEach(gene2 => {
                    const corr = calculateCorrelation(geneExpressions[gene1], geneExpressions[gene2]);
                    row.push(corr);
                });
                correlationMatrix.push(row);
                labels.push(gene1);
            });

            const heatmapTrace = {
                z: correlationMatrix,
                x: labels,
                y: labels,
                type: 'heatmap',
                colorscale: 'RdBu',
                zmid: 0,
                colorbar: { title: 'Correlation' },
                hovertemplate: '%{y} vs %{x}<br>Correlation: %{z:.3f}<extra></extra>'
            };

            const heatmapLayout = {
                title: 'Gene Expression Correlation Matrix',
                xaxis: { side: 'bottom' },
                yaxis: { autorange: 'reversed' },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { family: '-apple-system, BlinkMacSystemFont, Segoe UI, sans-serif' }
            };

            Plotly.newPlot('plot-heatmap', [heatmapTrace], heatmapLayout, { responsive: true });
        }

        function calculateCorrelation(x, y) {
            const n = x.length;
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);

            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

            return denominator === 0 ? 0 : numerator / denominator;
        }

        function createDataTable(tableData, containerId) {
            if (!tableData || tableData.length === 0) return;

            const headers = Object.keys(tableData[0]);
            const table = document.createElement('table');
            
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headers.forEach(h => {
                const th = document.createElement('th');
                th.textContent = h;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);

            const tbody = document.createElement('tbody');
            tbody.id = containerId + '-tbody';
            
            // Store full data for pagination
            table.dataset.fullData = JSON.stringify(tableData);
            table.dataset.currentPage = '0';
            
            renderTablePage(table, tableData, headers, 0);

            document.getElementById(containerId).innerHTML = '';
            document.getElementById(containerId).appendChild(table);
            
            // Add pagination controls
            createPaginationControls(containerId, tableData.length);
        }

        function renderTablePage(table, data, headers, page) {
            const rowsPerPage = 100;
            const start = page * rowsPerPage;
            const end = Math.min(start + rowsPerPage, data.length);
            
            let tbody = table.querySelector('tbody');
            if (tbody) tbody.remove();
            
            tbody = document.createElement('tbody');
            tbody.id = table.parentElement.id + '-tbody';
            
            data.slice(start, end).forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(h => {
                    const td = document.createElement('td');
                    const val = row[h];
                    td.textContent = typeof val === 'number' ? val.toExponential(3) : val;
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
        }

        function createPaginationControls(containerId, totalRows) {
            const rowsPerPage = 100;
            const totalPages = Math.ceil(totalRows / rowsPerPage);
            
            if (totalPages <= 1) return;
            
            const container = document.getElementById(containerId);
            const paginationDiv = document.createElement('div');
            paginationDiv.style.cssText = 'padding: 16px; text-align: center; display: flex; gap: 8px; justify-content: center; align-items: center;';
            paginationDiv.id = containerId + '-pagination';
            
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '← Previous';
            prevBtn.className = 'btn btn-secondary';
            prevBtn.style.fontSize = '13px';
            
            const pageInfo = document.createElement('span');
            pageInfo.style.cssText = 'padding: 0 16px; color: var(--color-text-secondary);';
            pageInfo.id = containerId + '-pageinfo';
            pageInfo.textContent = `Page 1 of ${totalPages}`;
            
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next →';
            nextBtn.className = 'btn btn-secondary';
            nextBtn.style.fontSize = '13px';
            
            let currentPage = 0;
            
            const updateButtons = () => {
                prevBtn.disabled = currentPage === 0;
                nextBtn.disabled = currentPage === totalPages - 1;
                pageInfo.textContent = `Page ${currentPage + 1} of ${totalPages}`;
                
                const table = container.querySelector('table');
                const fullData = JSON.parse(table.dataset.fullData);
                const headers = Object.keys(fullData[0]);
                renderTablePage(table, fullData, headers, currentPage);
            };
            
            prevBtn.onclick = () => {
                if (currentPage > 0) {
                    currentPage--;
                    updateButtons();
                }
            };
            
            nextBtn.onclick = () => {
                if (currentPage < totalPages - 1) {
                    currentPage++;
                    updateButtons();
                }
            };
            
            paginationDiv.appendChild(prevBtn);
            paginationDiv.appendChild(pageInfo);
            paginationDiv.appendChild(nextBtn);
            
            container.appendChild(paginationDiv);
            updateButtons();
        }

        function filterTables() {
            const query = document.getElementById('gene-search').value.toLowerCase();
            
            ['age', 'sex', 'survival'].forEach(type => {
                const tbody = document.getElementById(`table-container-${type}-tbody`);
                if (!tbody) return;
                
                Array.from(tbody.getElementsByTagName('tr')).forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(query) ? '' : 'none';
                });
            });
        }
    </script>
</body>
</html>
