<!DOCTYPE html><html lang="en"><head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Gene Expression &amp; Survival Dashboard</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --color-background: #07152b;
            --color-surface: #ecf0f3;
            --color-text: #222150;
            --color-text-secondary: #34573c;
            --color-primary: #21808d;
            --color-primary-hover: #1d7480;
            --color-border: rgba(94, 82, 64, 0.2);
            --color-card-border: rgba(94, 82, 64, 0.12);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: #1f2121;
                --color-surface: #262828;
                --color-text: #f5f5f5;
                --color-text-secondary: rgba(167, 169, 169, 0.7);
                --color-primary: #32b8c6;
                --color-primary-hover: #2da6b2;
                --color-border: rgba(119, 124, 124, 0.3);
                --color-card-border: rgba(119, 124, 124, 0.2);
            }
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            background: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
        }

        .header {
            background: var(--color-surface);
            border-bottom: 1px solid var(--color-card-border);
            padding: 24px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
        }

        .header h1 {
            margin: 0 0 8px 0;
            font-size: 28px;
            font-weight: 600;
            color: var(--color-text);
        }

        .header p {
            margin: 0;
            color: var(--color-text-secondary);
            font-size: 14px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        .controls {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .control-group label {
            font-size: 13px;
            font-weight: 500;
            color: var(--color-text);
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        select {
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 14px;
            cursor: pointer;
        }

        input {
            padding: 8px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            background: var(--color-surface);
            color: var(--color-text);
            font-size: 14px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: var(--color-primary);
            margin: 0;
        }

        .stat-label {
            font-size: 13px;
            color: var(--color-text-secondary);
            margin: 4px 0 0 0;
        }

        .card {
            background: var(--color-surface);
            border: 1px solid var(--color-card-border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .card h2 {
            margin: 0 0 16px 0;
            font-size: 20px;
            font-weight: 600;
            color: var(--color-text);
        }

        .plot-container {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            overflow: hidden;
        }

        .table-container {
            overflow-x: auto;
            max-height: 600px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            background: var(--color-surface);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            border-bottom: 2px solid var(--color-border);
            color: var(--color-text);
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--color-border);
        }

        tr:hover {
            background: rgba(0, 0, 0, 0.02);
        }

        .search-box {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 16px;
            background: var(--color-surface);
            color: var(--color-text);
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            border-bottom: 1px solid var(--color-border);
            flex-wrap: wrap;
        }

        .tab {
            padding: 10px 16px;
            cursor: pointer;
            border: none;
            background: transparent;
            color: var(--color-text-secondary);
            font-size: 14px;
            font-weight: 500;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }

        .tab:hover {
            color: var(--color-text);
        }

        .tab.active {
            color: var(--color-primary);
            border-bottom-color: var(--color-primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .plot-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        .plot-half {
            width: 100%;
            height: 400px;
        }

        .risk-table {
            margin-top: 20px;
            overflow-x: auto;
        }

        .risk-table table {
            font-size: 12px;
        }

        .gene-selector {
            margin-bottom: 16px;
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            align-items: center;
        }

        .gene-selector input {
            flex: 1;
            min-width: 200px;
        }

        .debug-msg {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 8px;
        }

        /* Pagination styles */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
            padding: 12px;
            background: var(--color-surface);
            border-top: 1px solid var(--color-border);
        }

        .pagination button {
            padding: 6px 12px;
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            color: var(--color-text);
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .pagination button:hover:not(:disabled) {
            background: var(--color-primary);
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination button.active {
            background: var(--color-primary);
            color: white;
        }

        .pagination-info {
            display: flex;
            align-items: center;
            font-size: 12px;
            color: var(--color-text-secondary);
            margin: 0 12px;
        }

        /* Warning message */
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            margin: 12px 0;
            font-size: 14px;
        }

        .warning strong {
            color: #856404;
        }
        /* AI assistant styles */
        .ai-fab {
            position: fixed;
            bottom: 50px;
            right: 20px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: var(--color-primary);
            color: #fff;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            z-index: 999;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .ai-fab:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.22);
        }
        .ai-panel {
            position: fixed;
            top: 0;
            right: -400px;
            width: 380px;
            height: 100vh;
            background: var(--color-surface);
            border-left: 1px solid var(--color-card-border);
            box-shadow: -6px 0 24px rgba(0, 0, 0, 0.18);
            transition: right 0.25s ease;
            z-index: 998;
            display: flex;
            flex-direction: column;
        }
        .ai-panel.open {
            right: 0;
        }
        .ai-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px;
            border-bottom: 1px solid var(--color-card-border);
            font-weight: 600;
            color: var(--color-text);
        }
        .ai-clear-btn {
            border: none;
            background: transparent;
            cursor: pointer;
            color: var(--color-text-secondary);
            font-size: 14px;
        }
        .ai-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .ai-message {
            padding: 12px;
            border-radius: 10px;
            line-height: 1.5;
            font-size: 14px;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .ai-message.user {
            background: rgba(33, 128, 141, 0.08);
            color: var(--color-text);
            align-self: flex-end;
        }
        .ai-message.assistant {
            background: rgba(0, 0, 0, 0.03);
            color: var(--color-text);
            border: 1px solid var(--color-card-border);
            align-self: flex-start;
        }
        .ai-input-area {
            padding: 12px;
            border-top: 1px solid var(--color-card-border);
            display: flex;
            gap: 8px;
        }
        .ai-input-area input {
            flex: 1;
            border-radius: 10px;
            border: 1px solid var(--color-border);
            padding: 10px;
            font-size: 14px;
        }
        .ai-send-btn {
            background: var(--color-primary);
            color: #fff;
            border: none;
            border-radius: 10px;
            padding: 0 14px;
            cursor: pointer;
            font-weight: 600;
        }
        .ai-typing {
            font-size: 12px;
            color: var(--color-text-secondary);
            padding: 0 16px 12px;
        }
        .ai-markdown code {
            background: rgba(0, 0, 0, 0.06);
            padding: 2px 4px;
            border-radius: 4px;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 12px;
        }
        .ai-markdown pre {
            background: rgba(0, 0, 0, 0.06);
            padding: 10px;
            border-radius: 8px;
            overflow: auto;
        }
        .ai-markdown ul {
            padding-left: 20px;
            margin: 6px 0;
        }
        .ai-action-btn {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
            background: var(--color-surface);
            color: var(--color-text);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }
        .ai-action-btn:hover {
            background: var(--color-primary);
            color: #fff;
        }
    </style>
    </head>
<body>
    <div class="header">
        <h1>Gene Expression &amp; Survival Analysis Dashboard</h1>
        <p>Interactive visualization of differential expression and patient survival data</p>
    </div>

    <div class="container">
        <div class="controls">
            <div class="control-group">
                <label>Survival Group By:</label>
                <select id="group-select">
                    <option value="Age_Group">Age Group</option>
                    <option value="Gender">Gender</option>
                    <option value="Survival_Group">Survival Group</option>
                </select>
            </div>
            <div class="control-group">
                <label>Volcano Plot Y-axis:</label>
                <select id="volcano-yaxis">
                    <option value="fdr">FDR</option>
                    <option value="p">P-value</option>
                </select>
            </div>
            <div class="control-group">
                <label>Gene for Expression:</label>
                <input type="text" id="gene-input" placeholder="Enter gene ID..."/>
            </div>
        </div>

        <div class="stats-grid" id="stats-grid"></div>

        <!-- VOLCANO PLOTS CARD -->
        <div class="card" id="volcano-card">
            <h2>Volcano Plots - Differential Expression</h2>
            <div class="tabs" id="volcano-tabs">
                <button class="tab volcano-tab active" data-tab="volcano-age" onclick="switchTab(event, &#39;volcano-age&#39;)">Age Group Comparison</button>
                <button class="tab volcano-tab" data-tab="volcano-sex" onclick="switchTab(event, &#39;volcano-sex&#39;)">Sex Comparison</button>
            </div>
            <div class="tab-content active" id="volcano-age">
                <div class="plot-container" id="plot-volcano-age"></div>
            </div>
            <div class="tab-content" id="volcano-sex">
                <div class="plot-container" id="plot-volcano-sex"></div>
            </div>
            <button class="ai-action-btn" onclick="aiInterpretVolcano()">AI Interpret Volcano</button>
        </div>

        <!-- KAPLAN-MEIER CARD -->
        <div class="card">
            <h2>Kaplan-Meier Survival Curves</h2>
            <div class="plot-container" id="plot-km"></div>
            <div class="risk-table" id="risk-table"></div>
            <button class="ai-action-btn" onclick="aiInterpretKM()">AI Interpret KM Curve</button>
        </div>

        <!-- GENE EXPRESSION CARD -->
        <div class="card">
            <h2>Gene Expression Analysis</h2>
            
            <!-- Warning about gene expression data -->
            <div class="warning">
                <strong>Note:</strong> Individual gene expression data is not available in the current dataset. 
                The plots below will show mean expression values for demonstration purposes. 
                Ensembl gene Id is used.
            </div>
            
            <div class="gene-selector">
                <input type="text" id="single-gene-input" placeholder="Enter gene ID for violin plot..."/>
                <button class="btn btn-primary" onclick="updateViolinPlots()">Plot Expression</button>
            </div>
            <div class="gene-selector">
                <input type="text" id="multi-gene-input" placeholder="Enter gene IDs (comma-separated) for heatmap..."/>
                <button class="btn btn-primary" onclick="updateHeatmap()">Plot Heatmap</button>
            </div>
            <div class="plot-grid">
                <div>
                    <h3 style="font-size: 16px; margin: 0 0 12px 0;">Expression by Age (≥65 vs &lt;65)</h3>
                    <div class="plot-half" id="plot-violin-age"></div>
                </div>
                <div>
                    <h3 style="font-size: 16px; margin: 0 0 12px 0;">Expression by Gender</h3>
                    <div class="plot-half" id="plot-violin-sex"></div>
                </div>
            </div>
            <div style="margin-top: 24px;">
                <h3 style="font-size: 16px; margin: 0 0 12px 0;">Gene Correlation Heatmap</h3>
                <div class="plot-container" id="plot-heatmap"></div>
            </div>
            <button class="ai-action-btn" onclick="aiExplainSingleGene()">AI Explain Gene Expression</button>
        </div>

        <!-- DATA TABLES CARD -->
        <div class="card">
            <h2>Gene Search &amp; Data Tables</h2>
            <input type="text" id="gene-search" class="search-box" placeholder="Search for a gene (e.g., ENSG00000000003)..."/>
            <div class="tabs" id="table-tabs">
                <button class="tab table-tab active" data-tab="table-age" onclick="switchTab(event, &#39;table-age&#39;)">Age Group DE</button>
                <button class="tab table-tab" data-tab="table-sex" onclick="switchTab(event, &#39;table-sex&#39;)">Sex DE</button>
                <button class="tab table-tab" data-tab="table-survival" onclick="switchTab(event, &#39;table-survival&#39;)">Patient Data</button>
            </div>
            <div class="tab-content active" id="table-age">
                <div class="table-container" id="table-container-age"></div>
            </div>
            <div class="tab-content" id="table-sex">
                <div class="table-container" id="table-container-sex"></div>
            </div>
            <div class="tab-content" id="table-survival">
                <div class="table-container" id="table-container-survival"></div>
            </div>
        </div>
    </div>

    <!-- AI floating button and panel -->
    <button class="ai-fab" id="ai-fab-btn" aria-label="Open AI Assistant">AI</button>
    <div class="ai-panel" id="ai-panel">
        <div class="ai-panel-header">
            <span>AI Assistant</span>
            <div style="display:flex; gap:8px; align-items:center;">
                <button class="ai-clear-btn" id="ai-clear-btn">Clear</button>
                <button class="ai-clear-btn" id="ai-close-btn" aria-label="Close AI panel">✕</button>
            </div>
        </div>
        <div class="ai-messages" id="ai-chat-log">
            <div class="ai-message assistant ai-markdown">Hi! Ask me about the volcano plots, KM curves, or genes.</div>
        </div>
        <div class="ai-typing" id="ai-typing" style="display:none;">Assistant is typing…</div>
        <div class="ai-input-area">
            <input id="ai-input" type="text" placeholder="Ask a question about the dashboard..."/>
            <button class="ai-send-btn" id="ai-send-btn">Send</button>
        </div>
    </div>

    <script>
        // Global data storage
        let data = {
            agegroup: null,
            sex: null,
            survival: null
        };
        const dashboardState = {
            currentKMGroup: document.getElementById('group-select') ? document.getElementById('group-select').value : null,
            currentGeneSingle: '',
            currentGenesMulti: [],
            volcanoYaxis: document.getElementById('volcano-yaxis') ? document.getElementById('volcano-yaxis').value : 'fdr'
        };
        // Expose for ai.js access
        window.dashboardData = data;
        window.dashboardState = dashboardState;

        // Table pagination state
        let tableState = {
            age: { currentPage: 1, rowsPerPage: 50, filteredData: [] },
            sex: { currentPage: 1, rowsPerPage: 50, filteredData: [] },
            survival: { currentPage: 1, rowsPerPage: 50, filteredData: [] }
        };

        // Auto-load files on page load
        window.addEventListener('load', function() {
            console.log('Page loaded, starting file fetch...');
            loadTSVFromURL('de_agegroup_mapped.tsv', 'agegroup');
            loadTSVFromURL('de_male_female_final.tsv', 'sex');
            loadTSVFromURL('dashboard_data.tsv', 'survival');
        });

        // Tab switching function
        function switchTab(event, tabId) {
            event.preventDefault();
            const button = event.target;
            const card = button.closest('.card');
            
            // Remove active from all tabs and contents in this card
            card.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
            card.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'))
            
            // Add active to clicked tab and corresponding content
            button.classList.add('active')
            card.querySelector(`#${tabId}`).classList.add('active')
        }

        // Event listeners
        document.getElementById('group-select').addEventListener('change', (e) => {
            dashboardState.currentKMGroup = e.target.value;
            updateKMPlot();
        });
        document.getElementById('gene-search').addEventListener('input', filterTables);
        document.getElementById('volcano-yaxis').addEventListener('change', () => {
            dashboardState.volcanoYaxis = document.getElementById('volcano-yaxis').value;
            console.log('Volcano Y-axis changed');
            if (data.agegroup) createVolcanoPlot(data.agegroup, 'plot-volcano-age', 'Age Group DE');
            if (data.sex) createVolcanoPlot(data.sex, 'plot-volcano-sex', 'Sex DE');
        });
        document.getElementById('gene-input').addEventListener('input', (e) => {
            const gene = e.target.value.trim();
            if (gene) {
                document.getElementById('single-gene-input').value = gene;
                dashboardState.currentGeneSingle = gene;
            }
        });
        document.getElementById('single-gene-input').addEventListener('input', (e) => {
            dashboardState.currentGeneSingle = e.target.value.trim();
        });
        document.getElementById('multi-gene-input').addEventListener('input', (e) => {
            dashboardState.currentGenesMulti = e.target.value.split(',').map(g => g.trim()).filter(Boolean);
        });

        function loadTSVFromURL(url, type) {
            console.log(`Starting fetch of ${url}...`);
            fetch(url)
                .then(response => {
                    console.log(`Fetch response for ${url}:`, response.status, response.ok);
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    return response.text();
                })
                .then(text => {
                    console.log(`Received ${text.length} characters for ${url}`);
                    const results = Papa.parse(text, {
                        header: true,
                        delimiter: '\t',
                        dynamicTyping: true,
                        skipEmptyLines: true
                    });
                    console.log(`Parsed ${results.data.length} rows for ${type}`);
                    data[type] = results.data;
                    console.log(`First row of ${type}:`, results.data[0]);
                    updateDashboard();
                })
                .catch(error => {
                    console.error(`Error loading ${url}:`, error);
                });
        }

        function updateDashboard() {
            console.log('Updating dashboard...');
            updateStats();
            if (data.agegroup) {
                console.log('Creating age group volcano plot...');
                createVolcanoPlot(data.agegroup, 'plot-volcano-age', 'Age Group DE');
                createDataTable(data.agegroup, 'table-container-age', 'age');
            }
            if (data.sex) {
                console.log('Creating sex volcano plot...');
                createVolcanoPlot(data.sex, 'plot-volcano-sex', 'Sex DE');
                createDataTable(data.sex, 'table-container-sex', 'sex');
            }
            if (data.survival) {
                console.log('Creating KM plot...');
                updateKMPlot();
                createDataTable(data.survival, 'table-container-survival', 'survival');
            }
        }

        function updateStats() {
            const statsGrid = document.getElementById('stats-grid');
            const stats = [];

            if (data.agegroup) {
                const sig = data.agegroup.filter(d => d.fdr < 0.05).length;
                stats.push({ value: data.agegroup.length, label: 'Genes (Age)' });
                stats.push({ value: sig, label: 'Significant (Age, FDR<0.05)' });
            }

            if (data.sex) {
                const sig = data.sex.filter(d => d.fdr < 0.05).length;
                stats.push({ value: data.sex.length, label: 'Genes (Sex)' });
                stats.push({ value: sig, label: 'Significant (Sex, FDR<0.05)' });
            }

            if (data.survival) {
                stats.push({ value: data.survival.length, label: 'Patients' });
                const events = data.survival.filter(d => d.Event === 1).length;
                stats.push({ value: events, label: 'Events' });
            }

            statsGrid.innerHTML = stats.map(s => `
                <div class="stat-card">
                    <p class="stat-value">${s.value.toLocaleString()}</p>
                    <p class="stat-label">${s.label}</p>
                </div>
            `).join('');
        }

        function createVolcanoPlot(deData, containerId, title) {
            console.log(`Creating volcano plot in ${containerId}...`);
            const yAxisType = document.getElementById('volcano-yaxis').value;
            const x = deData.map(d => d.mean_diff || 0);
            const y = deData.map(d => {
                const val = yAxisType === 'fdr' ? d.fdr : d.p;
                return val > 0 ? -Math.log10(val) : 0;
            });
            const genes = deData.map(d => d.gene);
            const colors = y.map(val => val > -Math.log10(0.05) ? 'red' : 'gray');

            const trace = {
                x: x,
                y: y,
                mode: 'markers',
                type: 'scatter',
                text: genes,
                marker: {
                    size: 5,
                    color: colors,
                    opacity: 0.6
                },
                hovertemplate: '<b>%{text}</b><br>Log2FC: %{x:.3f}<br>-log10: %{y:.2f}<extra></extra>'
            };

            const yAxisLabel = yAxisType === 'fdr' ? '-log10(FDR)' : '-log10(P-value)';

            const layout = {
                title: title,
                xaxis: { title: 'Log2 Fold Change (mean_diff)', zeroline: true },
                yaxis: { title: yAxisLabel },
                hovermode: 'closest',
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { family: '-apple-system, BlinkMacSystemFont, Segoe UI, sans-serif' }
            };

            Plotly.newPlot(containerId, [trace], layout, { responsive: true });
        }

        function updateKMPlot() {
            if (!data.survival) return;

            const groupBy = document.getElementById('group-select').value;
            const groups = {};

            data.survival.forEach(row => {
                const group = row[groupBy];
                if (!group) return;
                if (!groups[group]) groups[group] = [];
                groups[group].push({ time: row.Survival_Time, event: row.Event });
            });

            const traces = [];
            Object.keys(groups).forEach(group => {
                const kmData = calculateKM(groups[group]);
                traces.push({
                    x: kmData.times,
                    y: kmData.survival,
                    mode: 'lines',
                    name: group,
                    line: { shape: 'hv', width: 2 },
                    hovertemplate: '<b>' + group + '</b><br>Time: %{x}<br>Survival: %{y:.3f}<extra></extra>'
                });
            });

            const layout = {
                title: 'Kaplan-Meier Survival Curves by ' + groupBy,
                xaxis: { title: 'Survival Time (days)' },
                yaxis: { title: 'Survival Probability', range: [0, 1.05] },
                hovermode: 'closest',
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { family: '-apple-system, BlinkMacSystemFont, Segoe UI, sans-serif' }
            };

            Plotly.newPlot('plot-km', traces, layout, { responsive: true });
            createRiskTable(groups, groupBy);
        }

        function createRiskTable(groups, groupBy) {
            const riskTableDiv = document.getElementById('risk-table');
            
            let maxTime = 0;
            Object.values(groups).forEach(g => {
                g.forEach(d => {
                    if (d.time > maxTime) maxTime = d.time;
                });
            });
            
            const intervals = [];
            for (let t = 0; t <= maxTime; t += 100) {
                intervals.push(t);
            }
            
            const riskData = {};
            Object.keys(groups).forEach(group => {
                riskData[group] = intervals.map(time => {
                    return groups[group].filter(d => d.time >= time).length;
                });
            });
            
            let tableHTML = '<table><thead><tr><th>Time</th>';
            Object.keys(riskData).forEach(group => {
                tableHTML += `<th>${group}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';
            
            intervals.forEach((time, i) => {
                tableHTML += `<tr><td>${time}</td>`;
                Object.keys(riskData).forEach(group => {
                    tableHTML += `<td>${riskData[group][i]}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table>';
            riskTableDiv.innerHTML = tableHTML;
        }

        function calculateKM(data) {
            data.sort((a, b) => a.time - b.time);

            const times = [0];
            const survival = [1.0];
            let atRisk = data.length;
            let survProb = 1.0;

            data.forEach((d, i) => {
                if (d.event === 1) {
                    survProb *= (atRisk - 1) / atRisk;
                    times.push(d.time);
                    survival.push(survProb);
                }
                atRisk--;
            });

            return { times, survival };
        }

        function updateViolinPlots() {
            const geneId = document.getElementById('single-gene-input').value.trim();
            if (!geneId || !data.survival) {
                alert('Please enter a gene ID and load survival data first.');
                return;
            }
            dashboardState.currentGeneSingle = geneId;

            console.log(`Creating violin plots for gene: ${geneId}`);

            // Since individual gene expression data is not available, we'll use mean expression
            // and add some variation based on age and gender for demonstration
            const expressionData = data.survival.map(row => {
                const baseExpression = row.Mean_Expression || 0;
                // Add some variation based on age and gender for demonstration
                const ageEffect = (row.Age - 65) * 0.001; // Small age effect
                const genderEffect = row.Gender === 'Female' ? 0.05 : -0.05; // Small gender effect
                const expression = baseExpression + ageEffect + genderEffect + (Math.random() - 0.5) * 0.1;
                
                return {
                    age: row.Age,
                    ageGroup: row.Age >= 65 ? '≥65' : '<65',
                    gender: row.Gender,
                    expression: expression
                };
            }).filter(d => d.expression !== null && d.expression !== undefined);

            const ageGroups = { '≥65': [], '<65': [] };
            expressionData.forEach(d => {
                if (ageGroups[d.ageGroup]) {
                    ageGroups[d.ageGroup].push(d.expression);
                }
            });

            const ageTraces = Object.keys(ageGroups).map(group => ({
                y: ageGroups[group],
                type: 'violin',
                name: group,
                box: { visible: true },
                meanline: { visible: true }
            }));

            const ageLayout = {
                title: `Gene ${geneId} - Expression by Age Group`,
                yaxis: { title: 'Expression Level' },
                showlegend: true,
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { family: '-apple-system, BlinkMacSystemFont, Segoe UI, sans-serif' }
            };

            Plotly.newPlot('plot-violin-age', ageTraces, ageLayout, { responsive: true });

            const genders = {};
            expressionData.forEach(d => {
                if (!genders[d.gender]) genders[d.gender] = [];
                genders[d.gender].push(d.expression);
            });

            const genderTraces = Object.keys(genders).map(group => ({
                y: genders[group],
                type: 'violin',
                name: group,
                box: { visible: true },
                meanline: { visible: true }
            }));

            const genderLayout = {
                title: `Gene ${geneId} - Expression by Gender`,
                yaxis: { title: 'Expression Level' },
                showlegend: true,
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { family: '-apple-system, BlinkMacSystemFont, Segoe UI, sans-serif' }
            };

            Plotly.newPlot('plot-violin-sex', genderTraces, genderLayout, { responsive: true });
        }

        function updateHeatmap() {
            const geneInput = document.getElementById('multi-gene-input').value.trim();
            if (!geneInput || !data.survival) {
                alert('Please enter gene IDs (comma-separated) and load survival data first.');
                return;
            }

            const geneIds = geneInput.split(',').map(g => g.trim()).filter(g => g);
            if (geneIds.length < 2) {
                alert('Please enter at least 2 genes for correlation analysis.');
                return;
            }
            dashboardState.currentGenesMulti = geneIds;

            console.log(`Creating heatmap for genes: ${geneIds.join(', ')}`);

            // Since individual gene expression data is not available, we'll create
            // synthetic correlation data based on gene names for demonstration
            const correlationMatrix = [];
            
            geneIds.forEach((gene1, i) => {
                const row = [];
                geneIds.forEach((gene2, j) => {
                    if (i === j) {
                        row.push(1.0); // Self-correlation is 1
                    } else {
                        // Create synthetic correlation based on gene name similarity
                        const similarity = gene1 === gene2 ? 1 : 
                            (gene1.substring(0, 10) === gene2.substring(0, 10) ? 0.8 : 
                            (Math.random() - 0.5) * 0.8);
                        row.push(similarity);
                    }
                });
                correlationMatrix.push(row);
            });

            console.log('Correlation matrix:', correlationMatrix);

            const heatmapTrace = {
                z: correlationMatrix,
                x: geneIds,
                y: geneIds,
                type: 'heatmap',
                colorscale: 'RdBu',
                zmid: 0,
                zmin: -1,
                zmax: 1,
                colorbar: { title: 'Correlation' },
                hovertemplate: '%{y} vs %{x}<br>Correlation: %{z:.3f}<extra></extra>'
            };

            const heatmapLayout = {
                title: 'Gene Expression Correlation Matrix',
                xaxis: { side: 'bottom' },
                yaxis: { autorange: 'reversed' },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                font: { family: '-apple-system, BlinkMacSystemFont, Segoe UI, sans-serif' }
            };

            Plotly.newPlot('plot-heatmap', [heatmapTrace], heatmapLayout, { responsive: true });
        }

        function calculateCorrelation(x, y) {
            const n = x.length;
            if (n === 0) return 0;
            
            const sumX = x.reduce((a, b) => a + b, 0);
            const sumY = y.reduce((a, b) => a + b, 0);
            const sumXY = x.reduce((sum, xi, i) => sum + xi * y[i], 0);
            const sumX2 = x.reduce((sum, xi) => sum + xi * xi, 0);
            const sumY2 = y.reduce((sum, yi) => sum + yi * yi, 0);

            const numerator = n * sumXY - sumX * sumY;
            const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));

            return denominator === 0 ? 0 : numerator / denominator;
        }

        function createDataTable(tableData, containerId, tableType) {
            if (!tableData || tableData.length === 0) {
                console.warn(`No data for table ${containerId}`);
                return;
            }

            console.log(`Creating table ${containerId} with ${tableData.length} rows`);

            const headers = Object.keys(tableData[0]);
            const container = document.getElementById(containerId);
            
            // Initialize table state
            tableState[tableType].filteredData = tableData;
            tableState[tableType].currentPage = 1;
            
            renderTable(container, headers, tableData, tableType);
        }

        function renderTable(container, headers, data, tableType) {
            const state = tableState[tableType];
            const startIndex = (state.currentPage - 1) * state.rowsPerPage;
            const endIndex = Math.min(startIndex + state.rowsPerPage, data.length);
            const pageData = data.slice(startIndex, endIndex);
            
            let tableHTML = '<table><thead><tr>';
            headers.forEach(h => {
                tableHTML += `<th>${h}</th>`;
            });
            tableHTML += '</tr></thead><tbody>';

            pageData.forEach(row => {
                tableHTML += '<tr>';
                headers.forEach(h => {
                    const val = row[h];
                    const displayVal = typeof val === 'number' ? val.toExponential(3) : val;
                    tableHTML += `<td>${displayVal}</td>`;
                });
                tableHTML += '</tr>';
            });

            tableHTML += '</tbody></table>';
            
            // Add pagination
            const totalPages = Math.ceil(data.length / state.rowsPerPage);
            tableHTML += createPagination(state.currentPage, totalPages, data.length, state.rowsPerPage, tableType);
            
            container.innerHTML = tableHTML;
        }

        function createPagination(currentPage, totalPages, totalRows, rowsPerPage, tableType) {
            if (totalPages <= 1) return '';
            
            let paginationHTML = '<div class="pagination">';
            
            // Previous button
            paginationHTML += `<button onclick="changePage('${tableType}', ${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>‹ Prev</button>`;
            
            // Page info
            const startRow = (currentPage - 1) * rowsPerPage + 1;
            const endRow = Math.min(currentPage * rowsPerPage, totalRows);
            paginationHTML += `<div class="pagination-info">${startRow}-${endRow} of ${totalRows}</div>`;
            
            // Next button
            paginationHTML += `<button onclick="changePage('${tableType}', ${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Next ›</button>`;
            
            paginationHTML += '</div>';
            
            return paginationHTML;
        }

        function changePage(tableType, newPage) {
            const state = tableState[tableType];
            const totalPages = Math.ceil(state.filteredData.length / state.rowsPerPage);
            
            if (newPage >= 1 && newPage <= totalPages) {
                state.currentPage = newPage;
                
                // Re-render the table
                const containerId = `table-container-${tableType}`;
                const container = document.getElementById(containerId);
                const headers = Object.keys(state.filteredData[0]);
                renderTable(container, headers, state.filteredData, tableType);
            }
        }

        function filterTables() {
            const query = document.getElementById('gene-search').value.toLowerCase();
            
            ['age', 'sex', 'survival'].forEach(type => {
                const container = document.getElementById(`table-container-${type}`);
                if (!container) return;
                
                const originalData = data[type === 'age' ? 'agegroup' : type === 'sex' ? 'sex' : 'survival'];
                if (!originalData) return;
                
                // Filter data
                const filteredData = query ? originalData.filter(row => 
                    Object.values(row).some(val => 
                        String(val).toLowerCase().includes(query)
                    )
                ) : originalData;
                
                // Update table state
                tableState[type].filteredData = filteredData;
                tableState[type].currentPage = 1;
                
                // Re-render table
                const headers = Object.keys(originalData[0]);
                renderTable(container, headers, filteredData, type);
            });
        }
        // AI helper triggers – keep minimal to avoid touching core logic
        function aiInterpretVolcano() {
            if (window.aiAssistant && window.aiAssistant.interpretVolcano) {
                window.aiAssistant.interpretVolcano();
            } else {
                alert('AI Assistant not loaded yet.');
            }
        }
        function aiInterpretKM() {
            if (window.aiAssistant && window.aiAssistant.interpretKMPlot) {
                window.aiAssistant.interpretKMPlot();
            } else {
                alert('AI Assistant not loaded yet.');
            }
        }
        function aiExplainSingleGene() {
            if (window.aiAssistant && window.aiAssistant.explainGeneExpressionPattern) {
                window.aiAssistant.explainGeneExpressionPattern();
            } else {
                alert('AI Assistant not loaded yet.');
            }
        }
    </script>
    <script defer src="ai.js"></script>
</body></html>
